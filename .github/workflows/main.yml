name: Webtop with HTTPS (Tailscale cert)

on:
  workflow_dispatch:

jobs:
  webtop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale
        run: |
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTHKEY }} \
            --accept-dns=true

      # ðŸ”§ FIX: strip trailing dot from DNS name
      - name: Detect Tailscale hostname
        id: ts
        run: |
          HOST=$(tailscale status --json | jq -r '.Self.DNSName' | sed 's/\.$//')
          echo "host=$HOST" >> $GITHUB_OUTPUT
          echo "Detected hostname: $HOST"

      - name: Request TLS cert
        run: |
          sudo mkdir -p /etc/tailscale/certs
          sudo tailscale cert ${{ steps.ts.outputs.host }}
          sudo mv ${{ steps.ts.outputs.host }}.* /etc/tailscale/certs/

      - name: Pull Webtop
        run: |
          docker pull lscr.io/linuxserver/webtop:ubuntu-xfce

      - name: Run Webtop with HTTPS
        run: |
          docker run -d \
            --name webtop \
            --network host \
            --security-opt seccomp=unconfined \
            -e PUID=0 \
            -e PGID=0 \
            -e TZ=Asia/Kolkata \
            -e USERNAME=webtop \
            -e PASSWORD=github \
            -e SSL_CERT=/certs/${{ steps.ts.outputs.host }}.crt \
            -e SSL_KEY=/certs/${{ steps.ts.outputs.host }}.key \
            -v /etc/tailscale/certs:/certs:ro \
            lscr.io/linuxserver/webtop:ubuntu-xfce

      - name: Show HTTPS URL
        run: |
          echo "======================================"
          echo "âœ… Webtop Desktop is running with HTTPS"
          echo ""
          echo "Open in browser:"
          echo "https://${{ steps.ts.outputs.host }}:3000"
          echo ""
          echo "Username: webtop"
          echo "Password: github"
          echo "======================================"

      - name: Keep runner alive
        run: sleep 6h
