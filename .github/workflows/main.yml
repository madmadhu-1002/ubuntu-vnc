name: Ollama WizardLM via Tailscale

on:
  workflow_dispatch:

jobs:
  ollama:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      # Show system information
      - name: Show System Info
        run: |
          echo "=============================="
          echo "üñ• SYSTEM INFORMATION"
          echo "=============================="

          echo ""
          echo "üìå CPU:"
          lscpu | grep "Model name"

          echo ""
          echo "üìå RAM:"
          free -h

          echo ""
          echo "üìå Disk (ROM):"
          df -h

          echo ""
          echo "üìå Total Memory in MB:"
          grep MemTotal /proc/meminfo

          echo ""
          echo "üìå Storage Devices:"
          lsblk

          echo ""
          echo "=============================="

      # Verify Docker
      - name: Verify Docker
        run: docker --version

      # Install Tailscale
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      # Start Tailscale
      - name: Start Tailscale
        run: |
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTHKEY }} \
            --accept-dns=true

      # Get Tailscale IP
      - name: Get Tailscale IP
        id: tsip
        run: |
          IP=$(tailscale ip -4)
          echo "ip=$IP" >> $GITHUB_OUTPUT
          echo "Tailscale IP: $IP"

      # Start Ollama container
      - name: Start Ollama Docker
        run: |
          docker run -d \
            --name ollama \
            --network host \
            -e OLLAMA_NUM_PARALLEL=1 \
            -e OLLAMA_KEEP_ALIVE=5m \
            ghcr.io/ollama/ollama:latest

      # Pull WizardLM model
      - name: Pull WizardLM-13b-code
        run: |
          docker exec ollama ollama pull wizardlm-13b-code

      # Start Ollama API server
      - name: Start Ollama API
        run: |
          docker exec -d ollama ollama serve

      # Show API details
      - name: Show API Info
        run: |
          echo "======================================"
          echo "‚úÖ Ollama is running with WizardLM-13b-code"
          echo ""
          echo "üåê API Endpoint:"
          echo "http://${{ steps.tsip.outputs.ip }}:11434"
          echo ""
          echo "üß† Model: wizardlm-13b-code"
          echo ""
          echo "Test with:"
          echo "curl http://${{ steps.tsip.outputs.ip }}:11434/api/generate -d '{"
          echo '  "model": "wizardlm-13b-code",'
          echo '  "prompt": "Write a Python function to reverse a string."'
          echo "}'"
          echo "======================================"

      # Keep runner alive
      - name: Keep Runner Alive
        run: sleep 6h
