name: Ubuntu XFCE RDP via Tailscale

on:
  workflow_dispatch:

jobs:
  ubuntu-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Verify Docker
        run: |
          docker --version

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale
        run: |
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTHKEY }} \
            --accept-dns=true

      - name: Get Tailscale IP
        id: tsip
        run: |
          IP=$(tailscale ip -4)
          echo "ip=$IP" >> $GITHUB_OUTPUT
          echo "Tailscale IP: $IP"

      - name: Create docker-compose.yml
        run: |
          cat <<EOF > docker-compose.yml
          services:
            ubuntu-rdp:
              image: accetto/ubuntu-vnc-xfce
              container_name: ubuntu-rdp
              network_mode: host
              environment:
                TZ: Asia/Kolkata
                VNC_PASSWORD: password
              shm_size: "1gb"
              restart: unless-stopped
          EOF

      - name: Start Ubuntu XFCE container
        run: |
          docker compose up -d

      - name: Show RDP Login Details
        run: |
          echo "======================================"
          echo "âœ… Ubuntu XFCE Desktop is running"
          echo ""
          echo "ðŸ–¥ Connect using Windows Remote Desktop"
          echo ""
          echo "IP Address:"
          echo "${{ steps.tsip.outputs.ip }}"
          echo ""
          echo "Port: 3389"
          echo ""
          echo "Login:"
          echo "Username: headless"
          echo "Password: password"
          echo ""
          echo "Command:"
          echo "mstsc -> ${{ steps.tsip.outputs.ip }}:3389"
          echo "======================================"

      - name: Keep runner alive
        run: sleep 6h
