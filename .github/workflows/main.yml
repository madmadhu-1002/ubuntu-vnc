name: Ollama DeepSeek via Tailscale

on:
  workflow_dispatch:

jobs:
  ollama:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      # Show system info
      - name: Show System Info
        run: |
          echo "=============================="
          echo "üñ• SYSTEM INFORMATION"
          echo "=============================="
          echo ""
          echo "CPU:"
          lscpu | grep "Model name"
          echo ""
          echo "RAM:"
          free -h
          echo ""
          echo "Disk:"
          df -h
          echo "=============================="

      # Verify Docker
      - name: Verify Docker
        run: docker --version

      # Install Tailscale
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      # Start Tailscale
      - name: Start Tailscale
        run: |
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTHKEY }} \
            --accept-dns=true

      # Get Tailscale IP
      - name: Get Tailscale IP
        id: tsip
        run: |
          IP=$(tailscale ip -4)
          echo "ip=$IP" >> $GITHUB_OUTPUT
          echo "Tailscale IP: $IP"

      # Start Ollama container (DO NOT override command)
      - name: Start Ollama Container
        run: |
          docker run -d \
            --name ollama \
            -p 11434:11434 \
            -e OLLAMA_NUM_PARALLEL=2 \
            -e OLLAMA_KEEP_ALIVE=10m \
            --restart unless-stopped \
            ollama/ollama:latest

      # Wait for Ollama API to be ready
      - name: Wait for Ollama
        run: |
          echo "Waiting for Ollama..."
          for i in {1..30}; do
            if curl -s http://localhost:11434/api/tags > /dev/null; then
              echo "Ollama is ready!"
              break
            fi
            sleep 2
          done

      # Show container logs (debug safety)
      - name: Show Container Status
        run: |
          docker ps
          docker logs ollama || true

      # Pull DeepSeek model
      - name: Pull deepseek-coder:6.7b
        run: |
          docker exec ollama ollama pull deepseek-coder:6.7b

      # Show API Info
      - name: Show API Info
        run: |
          echo "======================================"
          echo "‚úÖ Ollama running with DeepSeek-Coder 6.7B"
          echo ""
          echo "üåê API Endpoint:"
          echo "http://${{ steps.tsip.outputs.ip }}:11434"
          echo ""
          echo "üß† Model: deepseek-coder:6.7b"
          echo ""
          echo "Test with:"
          echo "curl http://${{ steps.tsip.outputs.ip }}:11434/api/generate -d '{"
          echo '  "model": "deepseek-coder:6.7b",'
          echo '  "prompt": "Write a Python function to validate JWT tokens."'
          echo "}'"
          echo "======================================"

      # Keep runner alive
      - name: Keep Runner Alive
        run: sleep 6h
