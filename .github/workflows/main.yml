name: Webtop Desktop in Browser with Tailscale

on:
  workflow_dispatch:

jobs:
  webtop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Docker
        uses: docker/setup-buildx-action@v2

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale
        run: |
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTHKEY }} \
            --hostname=github-webtop \
            --accept-dns=false

      - name: Pull Webtop image
        run: |
          docker pull lscr.io/linuxserver/webtop:ubuntu-xfce

      - name: Run Webtop
        run: |
          docker run -d \
            --name webtop \
            --security-opt seccomp=unconfined \
            --network host \
            -e PUID=0 \
            -e PGID=0 \
            -e TZ=Asia/Kolkata \
            -e USERNAME=webtop \
            -e PASSWORD=github \
            -e WEBTOP_DISABLE_HTTPS=true \
            lscr.io/linuxserver/webtop:ubuntu-xfce

      - name: Print connection info
        run: |
          IP=$(tailscale ip -4)
          echo "=========================================="
          echo "Webtop Desktop is running!"
          echo ""
          echo "Open in your browser:"
          echo "  http://$IP:3000"
          echo ""
          echo "Login credentials:"
          echo "  Username: webtop"
          echo "  Password: github"
          echo "=========================================="

      - name: Keep runner alive
        run: sleep 6h
