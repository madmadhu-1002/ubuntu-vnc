name: Ubuntu VNC (Classic) with Tailscale

on:
  workflow_dispatch:

jobs:
  vnc:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install system packages
        run: |
          sudo apt update
          sudo apt install -y xfce4 xfce4-goodies tigervnc-standalone-server dbus-x11

      - name: Create VNC user
        run: |
          sudo useradd -m dev
          echo "dev:github" | sudo chpasswd

      - name: Setup VNC password
        run: |
          sudo -u dev mkdir -p /home/dev/.vnc
          echo "github" | sudo -u dev vncpasswd -f > /home/dev/.vnc/passwd
          sudo chmod 600 /home/dev/.vnc/passwd

      - name: Configure VNC startup
        run: |
          echo '#!/bin/sh
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          exec startxfce4 &' | sudo tee /home/dev/.vnc/xstartup
          sudo chmod +x /home/dev/.vnc/xstartup
          sudo chown -R dev:dev /home/dev/.vnc

      - name: Start VNC server
        run: |
          sudo -u dev vncserver -localhost no :1

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale
        run: |
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTHKEY }} \
            --hostname=github-vnc

      - name: Show connection info
        run: |
          echo "===================================="
          echo "âœ… VNC READY (CLASSIC)"
          echo ""
          echo "Address : $(tailscale ip -4):5901"
          echo "Username: dev"
          echo "Password: github"
          echo "===================================="

      - name: Keep runner alive
        run: sleep 6h
