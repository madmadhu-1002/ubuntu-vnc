name: Guacamole with HTTPS via Tailscale Serve

on:
  workflow_dispatch:

jobs:
  guacamole:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Verify Docker
        run: |
          docker --version
          docker compose version

      - name: Install jq
        run: |
          sudo apt update
          sudo apt install -y jq

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale
        run: |
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTHKEY }} \
            --accept-dns=true

      - name: Detect Tailscale hostname
        id: ts
        run: |
          HOST=$(tailscale status --json | jq -r '.Self.DNSName' | sed 's/\.$//')
          echo "host=$HOST" >> $GITHUB_OUTPUT

      - name: Create docker-compose.yml
        run: |
          cat <<EOF > docker-compose.yml
          services:
            guacamole:
              image: oznu/guacamole:latest
              container_name: guacamole
              ports:
                - "8080:8080"
              environment:
                EXTENSIONS: auth
              restart: unless-stopped
          EOF

      - name: Start Guacamole
        run: |
          docker compose up -d

      - name: Enable HTTPS with Tailscale Serve
        run: |
          sudo tailscale serve -bg http://localhost:8080

      - name: Show HTTPS URL
        run: |
          echo "======================================"
          echo "‚úÖ Guacamole is running with REAL HTTPS"
          echo ""
          echo "üåê Open in browser:"
          echo "https://${{ steps.ts.outputs.host }}"
          echo ""
          echo "üîê Login:"
          echo "Username: guacadmin"
          echo "Password: guacadmin"
          echo "======================================"

      - name: Keep runner alive
        run: sleep 6h
